# ‚ö†Ô∏è Matriz de Riesgos: Fase 1 ‚Äì Core Backbone
Este documento identifica los riesgos m√°s significativos para la planificaci√≥n y ejecuci√≥n de la Fase 1 (Core Backbone) y establece estrategias de mitigaci√≥n alineadas con las acciones del CTO y el backlog t√©cnico.

| ID | Riesgo | Impacto | Probabilidad | Nivel de Riesgo | Estrategia de Mitigaci√≥n |
|----|--------|---------|--------------|------------------|----------------------------|
| **R-01** | **Inconsistencia `kid` ‚Üî JWKS**<br>Los tokens emitidos contienen un `kid` no presente en el JWKS activo, causando fallos de validaci√≥n en servicios consumidores. | Cr√≠tico | Media | Alto | ‚Ä¢ Implementar **CI check autom√°tico** (H-06) que valide que todo token emitido tiene `kid` en JWKS.<br>‚Ä¢ Alertar en tiempo real si `kid_mismatch_detected_total > 0`.<br>‚Ä¢ Usar **rollover de 7 d√≠as** y TTL ‚â§1h en cach√© JWKS. |
| **R-02** | **Complejidad o latencia en anti-replay DPoP**<br>El mecanismo de nonce global introduce cuellos de botella o falla bajo alta carga (‚â•10k TPS). | Alto | Media | Alto | ‚Ä¢ Implementar **Redis regional con TTL ‚â§60s** y operaci√≥n `SETNX` (H-04).<br>‚Ä¢ **Evitar sincronizaci√≥n cross-regi√≥n** en Fase 1.<br>‚Ä¢ Ejecutar **perfil de carga sint√©tico** (10k TPS) como parte de QA. |
| **R-03** | **KMS/HSM indisponible en CI/CD**<br>El pipeline de integraci√≥n se bloquea por dependencia de infraestructura criptogr√°fica externa. | Alto | Alta | Alto | ‚Ä¢ Implementar **modo mock KMS en CI** (H-05) con claves ef√≠meras.<br>‚Ä¢ Usar **feature flags** para habilitar KMS real solo en staging/prod.<br>‚Ä¢ Documentar en `team_roles.md` al **Security Champion** como responsable. |
| **R-04** | **Fallo silencioso del modo fail-closed en Compliance**<br>Ante ca√≠da del `Compliance Service`, el sistema no deniega operaciones cr√≠ticas, generando decisiones legalmente inv√°lidas. | Cr√≠tico | Baja | Alto | ‚Ä¢ Ejecutar **chaos test espec√≠fico** (H-02): matar pod Compliance ‚Üí verificar 403 + log WORM.<br>‚Ä¢ Exponer m√©trica `compliance_fail_closed_trigger_count`.<br>‚Ä¢ Validar en PR que el circuit breaker est√° configurado (3 fallos ‚Üí open ‚Üí 30s timeout). |
| **R-05** | **Baja adopci√≥n o fallos de UX con Passkey en m√≥viles**<br>Los usuarios no completan el registro/login por problemas de compatibilidad o flujo confuso. | Medio | Alta | Medio | ‚Ä¢ Realizar **pruebas de usabilidad con usuarios reales** en iOS/Android (H-06).<br>‚Ä¢ Registrar tasas de √©xito y tiempos por plataforma.<br>‚Ä¢ Ofrecer **flujo de recuperaci√≥n claro** (TOTP como fallback temporal). |
| **R-06** | **Falta de trazabilidad por ausencia de eventos de Identity**<br>No se registran eventos clave (`AuthSuccess`, `SessionRevoked`), impidiendo auditor√≠a forense y correlaci√≥n. | Alto | Media | Alto | ‚Ä¢ Publicar eventos en **Schema Registry** con contratos versionados (H-07).<br>‚Ä¢ Validar en CI que los esquemas est√°n registrados.<br>‚Ä¢ Incluir `tenant_id` y `user_role` en atributos del evento. |
| **R-07** | **Interoperabilidad fallida con JWKS federados**<br>El sistema no consume correctamente JWKS de IdPs externos o durante rotaci√≥n forzada. | Alto | Media | Alto | ‚Ä¢ Desarrollar **suite de pruebas de interoperabilidad** (H-01) con JWKS simulado.<br>‚Ä¢ Validar rollover de 7 d√≠as y cach√© TTL ‚â§5m.<br>‚Ä¢ Exponer m√©trica `jwks_interop_rollover_success_rate`. |
| **R-08** | **Latencia inaceptable en flujos WebAuthn**<br>El P95 de registro/assertion supera los 3s, afectando la experiencia mobile-first. | Medio | Media | Medio | ‚Ä¢ Medir y reportar `webauthn_registration_latency_p95` y `webauthn_assertion_latency_p95` por plataforma (H-03).<br>‚Ä¢ Establecer SLOs diferenciados por iOS/Android/Web.<br>‚Ä¢ Optimizar con **pre-generaci√≥n de claves** y cach√© local. |
| **R-09** | **Gesti√≥n incorrecta de PII en User Profiles**<br>Atributos sensibles (DNI, etc.) se almacenan en texto claro o sin cifrado por tenant. | Cr√≠tico | Baja | Alto | ‚Ä¢ Aplicar **cifrado con clave KMS por tenant** (UP-10).<br>‚Ä¢ Revisar c√≥digo por **Security Champion** en cada PR que toque PII.<br>‚Ä¢ Validar con esc√°neres est√°ticos (Snyk, SonarQube). |
| **R-10** | **Propagaci√≥n incompleta de contexto de tenant**<br>El `tenant_id` no se inyecta en trazas/logs, impidiendo observabilidad por tenant. | Alto | Media | Alto | ‚Ä¢ Implementar **interceptor centralizado** que enriquezca contexto OTel (PLT-03).<br>‚Ä¢ Validar en CI que todos los spans incluyen `tenant_id` y `condominium_id`.<br>‚Ä¢ Incluir en **dashboard de m√©tricas** por tenant. |
| **R-11** | **üîê Riesgo de almacenamiento inseguro de tokens en Frontend**<br>Uso de `localStorage` o mecanismos inseguros para almacenar tokens de sesi√≥n. | Alto | Media | Alto | ‚Ä¢ Prohibir `localStorage` para tokens (ya incluido en checklist).<br>‚Ä¢ Usar cookies HTTPOnly o almacenamiento seguro v√≠a BFF.<br>‚Ä¢ Validar en QA y en revisiones de seguridad. |
| **R-12** | **üì± Riesgo de lectura incorrecta de QR de identidad**<br>Fallos en la lectura o validaci√≥n del QR en dispositivos m√≥viles. | Medio | Media | Medio | ‚Ä¢ Validar TTL de 300s y `kid` en COSE/JWS.<br>‚Ä¢ Pruebas E2E en Mobile para lectura y validaci√≥n.<br>‚Ä¢ M√©trica: `qr_identity_validation_error_rate`. |
| **R-13** | **üß© Riesgo de desalineaci√≥n entre Feature Flags y despliegue**<br>Flags activados/desactivados incorrectamente en ambientes productivos. | Medio | Alta | Medio | ‚Ä¢ Validar flags en CI/CD antes de cada despliegue.<br>‚Ä¢ Documentar en `feature_flags.md`.<br>‚Ä¢ M√©trica: `feature_flag_mismatch_detected_total`. |

---

## ‚úÖ Notas de Gesti√≥n
- **R-11 a R-13** agregados como parte de la revisi√≥n del checklist del Sprint 1.

- **Riesgos R-01 a R-08** est√°n directamente vinculados a las **acciones H-01 a H-07** del CTO Review.
- **R-09 y R-10** derivan de las **historias t√©cnicas faltantes** identificadas en el an√°lisis del backlog.
- Todos los riesgos de **nivel Alto** deben tener al menos **una m√©trica asociada** y un **owner expl√≠cito** (Tech Lead, Security Champion o QA Lead).
- Esta matriz debe actualizarse al inicio de cada sprint y revisarse en la retrospectiva.
