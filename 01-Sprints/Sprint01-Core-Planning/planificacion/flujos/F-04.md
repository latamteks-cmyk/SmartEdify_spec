### üìÑ F-04: Validaci√≥n de Membres√≠a y Contexto

```mermaid
sequenceDiagram
    participant Cliente as Cliente (Web/Mobile)
    participant BFF as BFF Layer
    participant GW as API Gateway
    participant UPS as User Profiles Service
    participant TS as Tenancy Service
    participant CS as Compliance Service
    participant Redis as Context Cache

    Cliente->>BFF: Solicita acceso a recurso (ej. reserva, firma)
    BFF->>GW: GET /profiles/{user}/memberships
    GW->>UPS: Consulta membres√≠as del usuario
    UPS->>TS: Verifica unidad, condominio, tenant
    TS->>TS: Aplica RLS por tenant_id y condominium_id
    TS-->>UPS: Resultado de validaci√≥n jer√°rquica
    UPS->>CS: Valida pol√≠ticas de contexto organizacional
    CS->>Redis: Consulta cache de pol√≠ticas activas
    Redis-->>CS: Pol√≠ticas vigentes
    CS-->>UPS: Resultado de validaci√≥n legal
    UPS-->>GW: Contexto v√°lido (o error)
    GW-->>BFF: Respuesta con contexto organizacional
    BFF-->>Cliente: Acceso autorizado (o denegado)
```
---

### üß© Artefactos t√©cnicos vinculados

**OpenAPI endpoint:** GET /profiles/{user}/memberships
**Modelo de datos:** relaci√≥n user ‚Üî unit ‚Üî condominium ‚Üî tenant
**M√©trica clave:** pdp_latency_p95
**Convenciones aplicadas:**
- PBAC con OPA (SAD ¬ß6.1)
- RLS por tenant_id y condominium_id
- Clean Architecture (PDR-2)
- Privacy by Design (PDR-4)

---
### üìä Activaci√≥n Condicional ‚Äî F-04

| Tipo de Operaci√≥n                            | ¬øRequiere F-04? | Justificaci√≥n T√©cnica                                                                 |
|---------------------------------------------|------------------|----------------------------------------------------------------------------------------|
| **Participaci√≥n en Asamblea**               | ‚úÖ S√≠            | Validaci√≥n de qu√≥rum y rol oficial; contexto legal y organizacional requerido.        |
| **Firma de Actas o Resoluciones**           | ‚úÖ S√≠            | Firma electr√≥nica vinculada a cargo oficial; requiere validaci√≥n jer√°rquica.          |
| **Gesti√≥n de Pagos / Caja / Cuotas**        | ‚úÖ S√≠            | Acceso a operaciones financieras sensibles; requiere trazabilidad legal.              |
| **Reservas de Espacios Comunes**            | ‚úÖ S√≠            | Validaci√≥n de elegibilidad por unidad, morosidad, convivencia de eventos.             |
| **Acceso a N√≥mina / RRHH / Exportes**       | ‚úÖ S√≠            | Operaciones con impacto fiscal y laboral; requiere contexto organizacional v√°lido.    |
| **Visualizaci√≥n de contenido p√∫blico**      | ‚ùå No            | No requiere validaci√≥n jer√°rquica ni legal; acceso general permitido.                 |
| **Actualizaci√≥n de preferencias personales**| ‚ùå No            | No afecta contexto legal ni jer√°rquico; operaci√≥n local del perfil.                   |
| **Acceso a notificaciones o mensajes**      | ‚ùå No            | No requiere validaci√≥n de membres√≠a; uso general del canal de comunicaci√≥n.           |
| **Activaci√≥n de cuenta (registro inicial)** | ‚ùå No            | Validaci√≥n ocurre en F-01; a√∫n no se requiere contexto organizacional completo.       |

---

### üîê Observaciones

- El flujo F-04 se activa **solo cuando la operaci√≥n depende del contexto organizacional y legal del usuario**.
- Est√° dise√±ado para proteger operaciones que requieren **trazabilidad, cumplimiento normativo y control jer√°rquico**.
- Se apoya en:
  - **RLS por `tenant_id` y `condominium_id`**
  - **PBAC con OPA**
  - **Validaci√≥n de pol√≠ticas activas v√≠a Compliance Service**

