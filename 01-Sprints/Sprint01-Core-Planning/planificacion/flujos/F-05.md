
### üìÑ **F-05: Generaci√≥n y Validaci√≥n de QR de Identidad**
```mermaid
sequenceDiagram
    participant Usuario as Usuario Final
    participant BFF as BFF Layer
    participant GW as API Gateway
    participant UPS as User Profiles Service
    participant IS as Identity Service
    participant CS as Compliance Service
    participant WORM as WORM Logs
    participant Validador as Servicio que consume el QR

    Usuario->>BFF: Solicita QR de identidad contextual
    BFF->>GW: POST /contextual-tokens
    GW->>UPS: Consulta cargo oficial y membres√≠a
    UPS->>CS: Valida pol√≠tica de uso de QR legal
    CS-->>UPS: Resultado de validaci√≥n
    UPS->>IS: Solicita generaci√≥n de QR firmado
    IS->>IS: Firma COSE/JWS con `kid`, TTL ‚â§ 300s
    IS->>WORM: Registra emisi√≥n con metadatos legales
    IS-->>GW: Devuelve QR firmado
    GW-->>BFF: QR legal entregado
    BFF-->>Usuario: QR disponible para escaneo

    Validador->>GW: POST /validate (escaneo de QR)
    GW->>IS: Verifica firma y validez temporal
    IS->>UPS: Verifica cargo oficial y contexto
    IS->>CS: Revalida pol√≠tica de uso
    CS-->>IS: Resultado de validaci√≥n
    IS-->>GW: Resultado de validaci√≥n
    GW-->>Validador: QR v√°lido / inv√°lido
```
### üß© Artefactos t√©cnicos vinculados

*   **OpenAPI endpoints**:
    *   `POST /contextual-tokens`
    *   `POST /validate`
*   **Especificaci√≥n COSE/JWS**:
    *   Claims: `user_id`, `role`, `unit_id`, `condominium_id`, `tenant_id`
    *   TTL ‚â§ 300s
    *   `kid` para firma con clave rotativa
*   **M√©tricas clave**:
    *   `qr_generation_latency_p95 ‚â§ 500ms`
    *   `qr_validation_error_rate`
*   **Convenciones aplicadas**:
    *   Firma electr√≥nica avanzada (Vision Doc ¬ß4.1)
    *   Device binding (SAD ¬ß9.4)
    *   Uso exclusivo para fines legales (ADR-014)
    *   WORM logging para trazabilidad
***

¬øTe gustar√≠a que lo exporte como archivo `.mmd` o que prepare tambi√©n el flujo **F-06**? Tambi√©n puedo ayudarte a definir el esquema COSE/JWS o los headers est√°ndar para validaci√≥n de QR.
